<dialog id="create-listing-modal"
    class="backdrop:bg-black/50 bg-transparent p-0 w-full max-w-sm m-auto rounded-3xl shadow-2xl open:animate-in open:fade-in open:zoom-in-95 backdrop:animate-in backdrop:fade-in">
    <div
        class="bg-background-light dark:bg-background-dark p-6 rounded-3xl border border-orange-100 dark:border-stone-800 shadow-soft relative overflow-hidden">
        <!-- Decorative Background -->
        <div
            class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl -z-10 transform translate-x-10 -translate-y-10">
        </div>

        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-text-main dark:text-white">New Listing</h3>
            <button onclick="document.getElementById('create-listing-modal').close()"
                class="p-2 rounded-full hover:bg-stone-100 dark:hover:bg-stone-800 text-stone-500 transition-colors">
                <span class="material-symbols-outlined text-[20px]">close</span>
            </button>
        </div>

        <form hx-post="/listings" hx-swap="afterbegin transition:true" hx-target="#listings-container" method="POST"
            enctype="multipart/form-data" class="flex flex-col gap-4"
            onsubmit="document.getElementById('create-listing-modal').close()">

            <!-- Type (No Request) -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Type</label>
                <select name="type"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white appearance-none">
                    <option value="Business">Business</option>
                    <option value="Service">Service</option>
                    <option value="Product">Product</option>
                    <option value="Food">Food (Restaurant/Catering)</option>
                    <option value="Event">Event ğŸ“…</option>
                    <option value="Job">Job</option>
                </select>
            </div>

            <!-- Title -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Title</label>
                <input required name="title" type="text" placeholder="e.g., Mama's Kitchen"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
            </div>

            <!-- Origin -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Origin</label>
                <select name="owner_origin"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white appearance-none">
                    <option value="Nigeria" selected>Nigeria ğŸ‡³ğŸ‡¬</option>
                    <option value="Benin">Benin ğŸ‡§ğŸ‡¯</option>
                    <option value="Burkina Faso">Burkina Faso ğŸ‡§ğŸ‡«</option>
                    <option value="Cabo Verde">Cabo Verde ğŸ‡¨ğŸ‡»</option>
                    <option value="Cote d'Ivoire">CÃ´te d'Ivoire ğŸ‡¨ğŸ‡®</option>
                    <option value="Gambia">Gambia ğŸ‡¬ğŸ‡²</option>
                    <option value="Ghana">Ghana ğŸ‡¬ğŸ‡­</option>
                    <option value="Guinea">Guinea ğŸ‡¬ğŸ‡³</option>
                    <option value="Guinea-Bissau">Guinea-Bissau ğŸ‡¬ğŸ‡¼</option>
                    <option value="Liberia">Liberia ğŸ‡±ğŸ‡·</option>
                    <option value="Mali">Mali ğŸ‡²ğŸ‡±</option>
                    <option value="Mauritania">Mauritania ğŸ‡²ğŸ‡·</option>
                    <option value="Niger">Niger ğŸ‡³ğŸ‡ª</option>
                    <option value="Senegal">Senegal ğŸ‡¸ğŸ‡³</option>
                    <option value="Sierra Leone">Sierra Leone ğŸ‡¸ğŸ‡±</option>
                    <option value="Togo">Togo ğŸ‡¹ğŸ‡¬</option>
                    <option value="Other">Other ğŸŒ</option>
                </select>
            </div>

            <!-- Image Upload -->
            <div class="flex flex-col gap-1.5">
                <label class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Photo
                    (Optional)</label>
                <input name="image" type="file" accept="image/*"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 transition-all text-text-sub">
                <!-- Location Section -->
                <div class="grid grid-cols-1 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Address
                            (Validated)</label>
                        <input id="create-address-input" required name="address" type="text"
                            placeholder="Start typing address..."
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                        <input type="hidden" id="create-city-input" name="city">
                    </div>
                </div>

                <script>
                    function initGoogleMaps() {
                        const input = document.getElementById('create-address-input');
                        if (!input) return;

                        const options = {
                            fields: ["address_components", "geometry", "formatted_address"],
                            types: ["address"],
                        };
                        const autocomplete = new google.maps.places.Autocomplete(input, options);
                        autocomplete.addListener("place_changed", () => {
                            const place = autocomplete.getPlace();
                            let city = "";
                            // Find city/locality
                            for (const component of place.address_components) {
                                const types = component.types;
                                if (types.includes("locality")) {
                                    city = component.long_name;
                                    break;
                                }
                                if (types.includes("postal_town")) {
                                    city = component.long_name;
                                }
                                if (!city && types.includes("administrative_area_level_2")) {
                                    city = component.long_name;
                                }
                            }

                            if (city) {
                                document.getElementById('create-city-input').value = city;
                            } else {
                                // Fallback
                                document.getElementById('create-city-input').value = "Unknown";
                            }

                            if (place.formatted_address) {
                                input.value = place.formatted_address;
                            }
                        });
                    }

                    // Check if Google Maps is loaded
                    if (typeof google === 'object' && typeof google.maps === 'object') {
                        initGoogleMaps();
                    } else {
                        // Load script
                        const script = document.createElement('script');
                        script.src = "https://maps.googleapis.com/maps/api/js?key={{.GoogleMapsApiKey}}&libraries=places&callback=initGoogleMaps";
                        script.async = true;
                        document.head.appendChild(script);
                    }
                </script>

                <!-- Description -->
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Description</label>
                    <textarea required name="description" rows="3" placeholder="Tell us about your listing..."
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white resize-none"></textarea>
                </div>

                <!-- Event Dates (Hidden by default) -->
                <div id="event-dates-section" class="grid grid-cols-2 gap-4 hidden">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Event
                            Start</label>
                        <input name="event_start" type="datetime-local"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Event
                            End</label>
                        <input name="event_end" type="datetime-local"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                    </div>
                </div>

                <!-- Job Fields (Hidden by default) -->
                <div id="job-fields-section" class="flex flex-col gap-4 hidden">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Company
                            Name</label>
                        <input name="company" type="text" placeholder="e.g. Acme Inc."
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Pay
                            Range (Optional)</label>
                        <input name="pay_range" type="text" placeholder="e.g. $80k - $120k / Competitive"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Skills
                            Required</label>
                        <textarea name="skills" rows="2" placeholder="e.g. Golang, SQL, Docker..."
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white resize-none"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1.5">
                            <label
                                class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Start
                                Date</label>
                            <input name="job_start_date" type="datetime-local"
                                class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                        </div>
                        <div class="flex flex-col gap-1.5">
                            <label
                                class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Apply
                                URL (Optional)</label>
                            <input name="job_apply_url" type="url" placeholder="https://..."
                                class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                        </div>
                    </div>
                </div>

                <script>
                    (function () {
                        const typeSelect = document.querySelector('#create-listing-modal select[name="type"]');
                        const eventSection = document.getElementById('event-dates-section');
                        const jobSection = document.getElementById('job-fields-section');
                        // Find the image upload container. It is the 4th top-level div in the form, or we search by input name
                        // Input structure: div > label + input
                        const imageInput = document.querySelector('#create-listing-modal input[name="image"]');
                        const imageSection = imageInput ? imageInput.parentElement : null;

                        function toggleFields() {
                            const val = typeSelect.value;

                            // Event Logic
                            if (val === 'Event') {
                                eventSection.classList.remove('hidden');
                                eventSection.querySelectorAll('input').forEach(i => i.required = true);
                            } else {
                                eventSection.classList.add('hidden');
                                eventSection.querySelectorAll('input').forEach(i => {
                                    i.required = false;
                                    i.value = '';
                                });
                            }

                            // Job Logic
                            if (val === 'Job') {
                                jobSection.classList.remove('hidden');
                                jobSection.querySelector('input[name="company"]').required = true;
                                jobSection.querySelector('textarea[name="skills"]').required = true;
                                jobSection.querySelector('input[name="job_start_date"]').required = true;

                                // Hide Image Upload for Jobs
                                if (imageSection) imageSection.style.display = 'none';
                            } else {
                                jobSection.classList.add('hidden');
                                jobSection.querySelectorAll('input, textarea').forEach(i => {
                                    i.required = false;
                                    i.value = '';
                                });

                                // Show Image Upload for others
                                if (imageSection) imageSection.style.display = 'flex';
                            }
                        }

                        typeSelect.addEventListener('change', toggleFields);
                        // Run on init just in case
                        toggleFields();
                    })();
                </script>

                <!-- Contact Section -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Email</label>
                        <input name="contact_email" type="email" placeholder="Email"
                            value="{{ if .User }}{{ .User.Email }}{{ end }}"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Phone/WhatsApp</label>
                        <input name="contact_phone" type="tel" placeholder="+1..."
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    </div>
                </div>

                <!-- Website (Optional) -->
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Website
                        (Optional)</label>
                    <input name="website_url" type="url" placeholder="https://..."
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                </div>

                <button type="submit"
                    class="mt-2 w-full flex items-center justify-center gap-2 bg-primary hover:bg-orange-600 text-white font-bold h-12 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-orange-500/20">
                    <span class="material-symbols-outlined text-[20px]">send</span>
                    Post Listing
                </button>
        </form>
    </div>
</dialog>