<dialog id="edit-listing-modal-{{.Listing.ID}}"
    class="backdrop:bg-black/50 bg-transparent p-0 w-full max-w-sm m-auto rounded-3xl shadow-2xl open:animate-in open:fade-in open:zoom-in-95 backdrop:animate-in backdrop:fade-in">
    <div
        class="bg-background-light dark:bg-background-dark p-6 rounded-3xl border border-orange-100 dark:border-stone-800 shadow-soft relative overflow-hidden">
        <!-- Decorative Background -->
        <div
            class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl -z-10 transform translate-x-10 -translate-y-10">
        </div>

        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-text-main dark:text-white">Edit Listing</h3>
            <button onclick="this.closest('dialog').close(); this.closest('dialog').remove();"
                class="p-2 rounded-full hover:bg-stone-100 dark:hover:bg-stone-800 text-stone-500 transition-colors">
                <span class="material-symbols-outlined text-[20px]">close</span>
            </button>
        </div>

        <form hx-put="/listings/{{.Listing.ID}}" hx-swap="outerHTML" hx-target="#listing-{{.Listing.ID}}" method="POST"
            enctype="multipart/form-data" class="flex flex-col gap-4" id="edit-form-{{.Listing.ID}}">

            <!-- Type -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Type</label>
                <select name="type"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white appearance-none">
                    <option value="Business" {{ if eq .Listing.Type "Business" }}selected{{ end }}>Business</option>
                    <option value="Service" {{ if eq .Listing.Type "Service" }}selected{{ end }}>Service</option>
                    <option value="Product" {{ if eq .Listing.Type "Product" }}selected{{ end }}>Product</option>
                    <option value="Food" {{ if eq .Listing.Type "Food" }}selected{{ end }}>Food (Restaurant/Catering)
                    </option>
                    <option value="Event" {{ if eq .Listing.Type "Event" }}selected{{ end }}>Event</option>
                    <option value="Request" {{ if eq .Listing.Type "Request" }}selected{{ end }}>Request</option>
                </select>
            </div>

            <!-- Title -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Title</label>
                <input required name="title" type="text" value="{{ .Listing.Title }}" placeholder="e.g., Mama's Kitchen"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
            </div>

            <!-- Origin -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Origin</label>
                <select name="owner_origin"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white appearance-none">
                    <option value="Nigeria" {{ if eq .Listing.OwnerOrigin "Nigeria" }}selected{{ end }}>Nigeria ğŸ‡³ğŸ‡¬
                    </option>
                    <option value="Benin" {{ if eq .Listing.OwnerOrigin "Benin" }}selected{{ end }}>Benin ğŸ‡§ğŸ‡¯</option>
                    <option value="Burkina Faso" {{ if eq .Listing.OwnerOrigin "Burkina Faso" }}selected{{ end }}>
                        Burkina Faso
                        ğŸ‡§ğŸ‡«</option>
                    <option value="Cabo Verde" {{ if eq .Listing.OwnerOrigin "Cabo Verde" }}selected{{ end }}>Cabo Verde
                        ğŸ‡¨ğŸ‡»
                    </option>
                    <option value="Cote d'Ivoire" {{ if eq .Listing.OwnerOrigin "Cote d'Ivoire" }}selected{{ end }}>CÃ´te
                        d'Ivoire ğŸ‡¨ğŸ‡®</option>
                    <option value="Gambia" {{ if eq .Listing.OwnerOrigin "Gambia" }}selected{{ end }}>Gambia ğŸ‡¬ğŸ‡²
                    </option>
                    <option value="Ghana" {{ if eq .Listing.OwnerOrigin "Ghana" }}selected{{ end }}>Ghana ğŸ‡¬ğŸ‡­</option>
                    <option value="Guinea" {{ if eq .Listing.OwnerOrigin "Guinea" }}selected{{ end }}>Guinea ğŸ‡¬ğŸ‡³
                    </option>
                    <option value="Guinea-Bissau" {{ if eq .Listing.OwnerOrigin "Guinea-Bissau" }}selected{{ end }}>
                        Guinea-Bissau ğŸ‡¬ğŸ‡¼</option>
                    <option value="Liberia" {{ if eq .Listing.OwnerOrigin "Liberia" }}selected{{ end }}>Liberia ğŸ‡±ğŸ‡·
                    </option>
                    <option value="Mali" {{ if eq .Listing.OwnerOrigin "Mali" }}selected{{ end }}>Mali ğŸ‡²ğŸ‡±</option>
                    <option value="Mauritania" {{ if eq .Listing.OwnerOrigin "Mauritania" }}selected{{ end }}>Mauritania
                        ğŸ‡²ğŸ‡·
                    </option>
                    <option value="Niger" {{ if eq .Listing.OwnerOrigin "Niger" }}selected{{ end }}>Niger ğŸ‡³ğŸ‡ª</option>
                    <option value="Senegal" {{ if eq .Listing.OwnerOrigin "Senegal" }}selected{{ end }}>Senegal ğŸ‡¸ğŸ‡³
                    </option>
                    <option value="Sierra Leone" {{ if eq .Listing.OwnerOrigin "Sierra Leone" }}selected{{ end }}>Sierra
                        Leone
                        ğŸ‡¸ğŸ‡±</option>
                    <option value="Togo" {{ if eq .Listing.OwnerOrigin "Togo" }}selected{{ end }}>Togo ğŸ‡¹ğŸ‡¬</option>
                    <option value="Other" {{ if eq .Listing.OwnerOrigin "Other" }}selected{{ end }}>Other ğŸŒ</option>
                </select>
            </div>

            <!-- Image Upload -->
            <div class="flex flex-col gap-1.5">
                <label class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Photo
                    (Optional)</label>
                {{ if .Listing.ImageURL }}
                <div class="mb-2">
                    <img src="{{ .Listing.ImageURL }}"
                        class="h-16 w-16 object-cover rounded-xl border border-stone-200">
                </div>
                {{ end }}
                <input name="image" type="file" accept="image/*"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 transition-all text-text-sub">
            </div>

            <!-- Description -->
            <div class="flex flex-col gap-1.5">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Description</label>
                <textarea required name="description" rows="3" placeholder="Tell us about your listing..."
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white resize-none">{{ .Listing.Description }}</textarea>
            </div>

            <!-- Request Deadline (Hidden by default unless Request) -->
            <div id="edit-request-section-{{.Listing.ID}}" class="flex flex-col gap-1.5 hidden">
                <label
                    class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Deadline</label>
                <input name="deadline_date" type="date"
                    value="{{ if not .Listing.Deadline.IsZero }}{{ .Listing.Deadline.Format " 2006-01-02" }}{{ end }}"
                    class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
            </div>

            <!-- Job Details (Hidden by default unless Job) -->
            <div id="edit-job-section-{{.Listing.ID}}" class="flex flex-col gap-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Company</label>
                        <input name="company" type="text" value="{{ .Listing.Company }}" placeholder="Company Name"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Pay
                            Range</label>
                        <input name="pay_range" type="text" value="{{ .Listing.PayRange }}"
                            placeholder="e.g. 150k-200k / yr"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                    </div>
                </div>

                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Skills</label>
                    <input name="skills" type="text" value="{{ .Listing.Skills }}"
                        placeholder="e.g. Golang, SQL, Docker"
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Start
                            Date</label>
                        <input name="job_start_date" type="datetime-local"
                            value='{{ if not .Listing.JobStartDate.IsZero }}{{ .Listing.JobStartDate.Format "2006-01-02T15:04" }}{{ end }}'
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Apply
                            URL</label>
                        <input name="job_apply_url" type="url" value="{{ .Listing.JobApplyURL }}"
                            placeholder="https://..."
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                    </div>
                </div>
            </div>

            <!-- Event Dates (Hidden by default unless Event) -->
            <div id="edit-event-dates-section-{{.Listing.ID}}" class="grid grid-cols-2 gap-4 hidden">
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Event
                        Start</label>
                    <input name="event_start" type="datetime-local"
                        value='{{ if not .Listing.EventStart.IsZero }}{{ .Listing.EventStart.Format "2006-01-02T15:04" }}{{ end }}'
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                </div>
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Event
                        End</label>
                    <input name="event_end" type="datetime-local"
                        value='{{ if not .Listing.EventEnd.IsZero }}{{ .Listing.EventEnd.Format "2006-01-02T15:04" }}{{ end }}'
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-text-main dark:text-white placeholder:text-stone-400">
                </div>
            </div>

            <script>
                (function () {
                    const form = document.querySelector('#edit-listing-modal-{{.Listing.ID}} form');
                    if (!form) return;

                    const typeSelect = form.querySelector('select[name="type"]');
                    const eventSection = document.getElementById('edit-event-dates-section-{{.Listing.ID}}');
                    const requestSection = document.getElementById('edit-request-section-{{.Listing.ID}}');
                    const jobSection = document.getElementById('edit-job-section-{{.Listing.ID}}');

                    function toggleFields() {
                        const val = typeSelect.value;

                        // Reset all sections
                        eventSection.classList.add('hidden');
                        requestSection.classList.add('hidden');
                        jobSection.classList.add('hidden');

                        // Reset required attributes
                        [eventSection, requestSection, jobSection].forEach(section => {
                            section.querySelectorAll('input').forEach(i => i.required = false);
                        });

                        // Event Logic
                        if (val === 'Event') {
                            eventSection.classList.remove('hidden');
                            eventSection.querySelectorAll('input').forEach(i => i.required = true);
                        }
                        // Request Logic
                        else if (val === 'Request') {
                            requestSection.classList.remove('hidden');
                        }
                        // Job Logic
                        else if (val === 'Job') {
                            jobSection.classList.remove('hidden');
                            jobSection.querySelectorAll('input').forEach(i => i.required = true);
                        }

                        // Address Requirement Logic
                        const addressInput = document.getElementById('edit-address-input-{{.Listing.ID}}');
                        if (addressInput) {
                            if (val === 'Service' || val === 'Job' || val === 'Request') {
                                addressInput.required = false;
                                addressInput.placeholder = "Address (Optional)";
                                const label = addressInput.previousElementSibling;
                                if (label) label.textContent = "Address (Optional)";
                            } else {
                                addressInput.required = true;
                                addressInput.placeholder = "Start typing address...";
                                const label = addressInput.previousElementSibling;
                                if (label) label.textContent = "Address (Validated)";
                            }
                        }

                        // Hours of Operation Logic
                        const hoursInput = document.querySelector('#edit-listing-modal-{{.Listing.ID}} input[name="hours_of_operation"]');
                        if (hoursInput) {
                            const hoursContainer = hoursInput.closest('div');
                            // Allowed: Business, Service, Food
                            if (val === 'Business' || val === 'Service' || val === 'Food') {
                                if (hoursContainer) hoursContainer.classList.remove('hidden');
                                hoursInput.disabled = false;
                            } else {
                                if (hoursContainer) hoursContainer.classList.add('hidden');
                                hoursInput.value = '';
                                hoursInput.disabled = true;
                            }
                        }
                    }

                    typeSelect.addEventListener('change', toggleFields);
                    // Run on init
                    toggleFields();
                })();
            </script>

            <!-- Neighborhood -->
            <!-- Location Section -->
            <div class="grid grid-cols-1 gap-4">
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Address
                        (Validated)</label>
                    <input id="edit-address-input-{{.Listing.ID}}" name="address" type="text"
                        value="{{ .Listing.Address }}" placeholder="Start typing address..."
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    <input type="hidden" id="edit-city-input-{{.Listing.ID}}" name="city" value="{{ .Listing.City }}">
                    <div class="h-full w-full bg-center bg-cover rounded-xl dynamic-bg"
                        data-bg-image="{{.Listing.ImageURL}}" data-alt="{{ .Listing.Title }}">
                    </div>
                </div>

                <!-- Hours of Operation (Optional) -->
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Hours
                        of Operation</label>
                    <input name="hours_of_operation" type="text" value="{{ .Listing.HoursOfOperation }}"
                        placeholder="e.g. Mon-Fri 9am-6pm"
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                </div>

                <script>
                    (function () {
                        function initEditMaps() {
                            const input = document.getElementById('edit-address-input-{{.Listing.ID}}');
                            if (!input) return;

                            const options = {
                                fields: ["address_components", "geometry", "formatted_address"],
                                types: ["address"],
                            };
                            const autocomplete = new google.maps.places.Autocomplete(input, options);
                            autocomplete.addListener("place_changed", () => {
                                const place = autocomplete.getPlace();
                                let city = "";
                                for (const component of place.address_components) {
                                    const types = component.types;
                                    if (types.includes("locality")) {
                                        city = component.long_name;
                                        break;
                                    }
                                    if (types.includes("postal_town")) {
                                        city = component.long_name;
                                    }
                                    if (!city && types.includes("administrative_area_level_2")) {
                                        city = component.long_name;
                                    }
                                }

                                if (city) {
                                    document.getElementById('edit-city-input-{{.Listing.ID}}').value = city;
                                }

                                if (place.formatted_address) {
                                    input.value = place.formatted_address;
                                }
                            });
                        }

                        if (typeof google === 'object' && typeof google.maps === 'object') {
                            initEditMaps();
                        } else {
                            // Fallback if script isn't loaded yet (unlikely if index loaded it, but safe)
                            // For edit modal, we assume base loaded it. If not, we might have issue.
                            // But Create Modal logic handles loading.
                        }
                    })();
                </script>

                <!-- Contact Section -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Email</label>
                        <input name="contact_email" type="email" value="{{ .Listing.ContactEmail }}"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label
                            class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Phone</label>
                        <input name="contact_phone" type="tel" value="{{ .Listing.ContactPhone }}"
                            class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                    </div>
                </div>

                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">WhatsApp</label>
                    <input name="contact_whatsapp" type="tel" value="{{ .Listing.ContactWhatsApp }}"
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                </div>

                <!-- Website (Optional) -->
                <div class="flex flex-col gap-1.5">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-text-sub dark:text-stone-400 ml-1">Website
                        (Optional)</label>
                    <input name="website_url" type="url" value="{{ .Listing.WebsiteURL }}"
                        class="w-full bg-white dark:bg-surface-dark border border-stone-200 dark:border-stone-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-stone-400 text-text-main dark:text-white">
                </div>

                <button type="submit"
                    class="mt-2 w-full flex items-center justify-center gap-2 bg-primary hover:bg-orange-600 text-white font-bold h-12 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-orange-500/20">
                    Save Changes
                </button>
        </form>
    </div>
</dialog>